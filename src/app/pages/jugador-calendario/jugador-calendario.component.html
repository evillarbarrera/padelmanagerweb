<div class="admin-layout">
  <!-- Sidebar -->
  <!-- Sidebar -->
  <app-sidebar [userId]="userId" [jugadorNombre]="jugadorNombre" [jugadorFoto]="jugadorFoto" activePage="calendario">
  </app-sidebar>

  <!-- Main Content Area -->
  <main class="main-content">

    <!-- Content -->
    <div class="dashboard-grid">

      <!-- Page Actions / Tabs -->
      <div class="page-header">
        <h2 class="section-title">Mis Clases</h2>
        <div class="view-toggles">
          <button class="btn-toggle" [class.active]="vistaActual === 'activas'" (click)="cambiarVista('activas')">
            üìã Activas
          </button>
          <button class="btn-toggle" [class.active]="vistaActual === 'historial'" (click)="cambiarVista('historial')">
            üï∞ Historial
          </button>
        </div>
      </div>

      <!-- VISTA 1: ACTIVAS -->
      <div *ngIf="vistaActual === 'activas'" class="animate-fade-in">

        <div *ngIf="isLoading" class="loading-state">
          <div class="spinner"></div>
          <p>Cargando tus reservas...</p>
        </div>

        <div *ngIf="!isLoading && reservasFuturas.length === 0" class="empty-state">
          <div class="empty-icon">üì≠</div>
          <h3>No tienes reservas activas</h3>
          <p>Agenda tu pr√≥xima clase para comenzar a entrenar.</p>
          <button class="btn-secondary-action" (click)="irAReservas()">Agendar Nueva Clase</button>
        </div>

        <div *ngIf="!isLoading && reservasFuturas.length > 0" class="reservations-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Entrenador</th>
                <th>Fecha</th>
                <th>Horario</th>
                <th>Modalidad</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let reserva of paginatedReservas">
                <td>
                  <div class="user-cell">
                    <div class="avatar-wrapper">
                      <img class="avatar-small"
                        [src]="reserva.entrenador_foto || 'assets/images/placeholder_avatar.png'"
                        style="object-fit: cover;">
                      <div class="online-indicator"></div>
                    </div>
                    <div class="user-info">
                      <span class="user-name">{{ reserva.entrenador_nombre }}</span>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="date-cell">
                    <span class="main-date">{{ reserva.fecha | date: 'dd MMM yyyy' }}</span>
                    <span class="relative-date">{{ reserva.fecha | date: 'EEEE' | titlecase }}</span>
                  </div>
                </td>
                <td>
                  <div class="time-cell">
                    <span class="time-range">{{ (reserva.hora_inicio || reserva.hora || '') | slice:0:5 }} - {{
                      (reserva.hora_fin || '') | slice:0:5 }}</span>
                  </div>
                </td>
                <td>
                  <div class="modalidad-cell">
                    <span class="badge-modalidad" [class.grupal]="reserva.tipo === 'grupal'"
                      [class.multi]="reserva.cantidad_personas > 1 && reserva.tipo !== 'grupal'"
                      [class.individual]="reserva.tipo !== 'grupal' && reserva.cantidad_personas <= 1">

                      <i class="icon">{{ (reserva.tipo === 'grupal' || reserva.cantidad_personas > 1) ? 'üë•' : 'üë§'
                        }}</i>

                      <ng-container *ngIf="reserva.tipo === 'grupal'">
                        GRUPAL ({{ reserva.cupos_ocupados }}/{{ reserva.capacidad_maxima }})
                      </ng-container>
                      <ng-container *ngIf="reserva.tipo !== 'grupal'">
                        {{ reserva.cantidad_personas > 1 ? 'MULTIJUGADOR' : 'INDIVIDUAL' }}
                      </ng-container>
                    </span>
                  </div>
                </td>
                <td>
                  <ng-container *ngIf="reserva.tipo === 'grupal'">
                    <div class="status-container">
                      <span class="status-badge" [class]="reserva.estado_grupo?.toLowerCase()">
                        <i class="status-icon">{{ reserva.estado_grupo === 'activo' ? 'üî•' : '‚è≥' }}</i>
                        {{ reserva.estado_grupo === 'activo' ? 'ACTIVADA' : 'PENDIENTE' }}
                      </span>
                      <div class="info-wrapper" *ngIf="reserva.estado_grupo !== 'activo'">
                        <div class="info-icon">i</div>
                        <div class="info-tooltip">
                          Esta clase se activar√° cuando se alcance el m√≠nimo de
                          <b>{{ reserva.capacidad_minima || 4 }} jugadores</b>.
                        </div>
                      </div>
                    </div>
                  </ng-container>
                  <ng-container *ngIf="reserva.tipo !== 'grupal'">
                    <span class="status-badge" [class]="reserva.estado?.toLowerCase()">
                      <i class="status-icon">‚úÖ</i>
                      {{ reserva.estado | uppercase }}
                    </span>
                  </ng-container>
                </td>
                <td>
                  <div class="actions-column">
                    <div class="actions-buttons">
                      <button class="btn-action cancel" (click)="cancelarReserva(reserva)"
                        [disabled]="reserva.estado !== 'reservado' && reserva.estado !== 'activo' && reserva.estado !== 'pendiente'"
                        title="Cancelar Reserva">
                        CANCELAR RESERVA
                      </button>
                    </div>

                    <!-- Equipo integration -->
                    <div class="team-footer" *ngIf="reserva.cantidad_personas > 1">
                      <div class="team-chips">
                        <div class="chip-item owner" title="T√∫ (Titular)">
                          <span class="letter">{{ jugadorNombre.charAt(0) }}</span>
                        </div>
                        <div class="chip-item guest" *ngFor="let inv of reserva.invitados"
                          [title]="inv.nombre + (inv.estado === 'pendiente' ? ' (Pendiente)' : '')"
                          [class.pending]="inv.estado === 'pendiente'">
                          <span class="letter">{{ inv.nombre.charAt(0) }}</span>
                          <span class="status-dot" *ngIf="inv.estado === 'pendiente'"></span>
                        </div>
                        <button class="btn-add-team" *ngIf="(reserva.invitados?.length + 1) < reserva.cantidad_personas"
                          (click)="abrirModalInvitacion(reserva)" title="Invitar Compa√±ero">
                          <span class="plus">+</span>
                        </button>
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="mobile-cards">
            <div *ngFor="let reserva of paginatedReservas" class="reserva-card-mobile">
              <div class="card-header-mobile">
                <span class="date">{{ reserva.fecha | date: 'dd MMM' }}</span>
                <span class="badge-modalidad-mobile" [class.grupal]="reserva.tipo === 'grupal'"
                  [class.multi]="reserva.cantidad_personas > 1 && reserva.tipo !== 'grupal'">
                  {{ (reserva.tipo === 'grupal') ? ('üë• Grupal (' + reserva.cupos_ocupados + '/' +
                  reserva.capacidad_maxima + ')') : (reserva.cantidad_personas > 1 ? 'üë• MULTIJUGADOR' : 'üë§
                  Individual') }}
                </span>
              </div>
              <div class="card-body-mobile">
                <h3>{{ reserva.nombre_entrenador || reserva.entrenador_nombre }}</h3>
                <p>{{ (reserva.hora_inicio || reserva.hora) | slice:0:5 }} - {{ reserva.hora_fin | slice:0:5 }}</p>
                <div class="status-mobile" style="margin-top: 8px;">
                  <ng-container *ngIf="reserva.tipo === 'grupal'">
                    <div class="status-container" style="display: flex; align-items: center; gap: 8px;">
                      <span class="status-badge" [class]="reserva.estado_grupo?.toLowerCase()">
                        {{ reserva.estado_grupo === 'activo' ? 'üî• Activada' : '‚è≥ Pendiente' }}
                      </span>
                      <div class="info-wrapper" *ngIf="reserva.estado_grupo !== 'activo'">
                        <div class="info-icon"
                          style="width: 16px; height: 16px; background: #f0f0f0; border: 1px solid #ddd; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; font-style: italic;">
                          i</div>
                      </div>
                    </div>
                    <p *ngIf="reserva.estado_grupo !== 'activo'" style="font-size: 11px; color: #666; margin-top: 4px;">
                      Se activa con {{ reserva.capacidad_minima || 4 }} jugadores.
                    </p>
                  </ng-container>
                  <ng-container *ngIf="reserva.tipo !== 'grupal'">
                    <span class="status-badge" [class]="reserva.estado?.toLowerCase()">
                      {{ reserva.estado }}
                    </span>
                  </ng-container>
                </div>

                <!-- Mi Equipo Mobile -->
                <div class="team-section-mobile" *ngIf="reserva.cantidad_personas > 1">
                  <p class="section-label">Mi Equipo:</p>
                  <div class="team-members-mobile">
                    <span class="member-dot me" title="T√∫"></span>
                    <span class="member-dot guest" *ngFor="let inv of reserva.invitados"
                      [class.pending]="inv.estado === 'pendiente'" [title]="inv.nombre"></span>
                    <button class="add-dot" *ngIf="(reserva.invitados?.length + 1) < reserva.cantidad_personas"
                      (click)="abrirModalInvitacion(reserva)">+</button>
                  </div>
                </div>
              </div>
              <div class="card-actions-mobile">
                <button class="btn-cancel-action full-width" (click)="cancelarReserva(reserva)">Cancelar
                  reserva</button>
                <button class="btn-invite-action full-width" style="margin-top: 8px;"
                  *ngIf="reserva.pack_jugador_id && reserva.cantidad_personas > 1 && (reserva.invitados?.length + 1) < reserva.cantidad_personas"
                  (click)="abrirModalInvitacion(reserva)">
                  + Invitar Compa√±ero
                </button>
              </div>
            </div>
          </div>

          <!-- Pagination Controls -->
          <div class="pagination-controls" *ngIf="totalPages > 1">
            <button class="btn-page" (click)="prevPage()" [disabled]="currentPage === 1">Anterior</button>
            <span class="page-info">P√°gina {{ currentPage }} de {{ totalPages }}</span>
            <button class="btn-page" (click)="nextPage()" [disabled]="currentPage === totalPages">Siguiente</button>
          </div>
        </div>
      </div>

      <!-- VISTA 2: HISTORIAL -->
      <div *ngIf="vistaActual === 'historial'" class="animate-fade-in">

        <div *ngIf="isLoading" class="loading-state">
          <div class="spinner"></div>
          <p>Cargando historial...</p>
        </div>

        <div *ngIf="!isLoading && reservasPasadas.length === 0" class="empty-state">
          <div class="empty-icon">üìú</div>
          <h3>Sin Historial</h3>
          <p>A√∫n no tienes clases finalizadas.</p>
        </div>

        <div *ngIf="!isLoading && reservasPasadas.length > 0" class="reservations-container">
          <table class="data-table">
            <thead>
              <tr>
                <th>Entrenador</th>
                <th>Fecha</th>
                <th>Horario</th>
                <th>Estado</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let reserva of paginatedReservas">
                <td>
                  <div class="user-cell">
                    <div class="avatar-small">{{ reserva.nombre_entrenador?.charAt(0) ||
                      reserva.entrenador_nombre?.charAt(0) || 'E' }}</div>
                    <span class="font-medium">{{ reserva.nombre_entrenador || reserva.entrenador_nombre }}</span>
                  </div>
                </td>
                <td>{{ reserva.fecha | date: 'dd MMM yyyy' }}</td>
                <td>{{ (reserva.hora_inicio | slice:0:5) }} - {{ (reserva.hora_fin | slice:0:5) }}</td>
                <td>
                  <span class="status-badge" [class]="reserva.estado?.toLowerCase()">
                    {{ reserva.estado }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>

          <div class="mobile-cards">
            <div *ngFor="let reserva of paginatedReservas" class="reserva-card-mobile past">
              <div class="card-header-mobile">
                <span class="date">{{ reserva.fecha | date: 'dd MMM' }}</span>
                <span class="status-badge" [class]="reserva.estado?.toLowerCase()">{{ reserva.estado }}</span>
              </div>
              <div class="card-body-mobile">
                <h3>{{ reserva.nombre_entrenador || reserva.entrenador_nombre }}</h3>
                <p>{{ reserva.hora_inicio | slice:0:5 }} - {{ reserva.hora_fin | slice:0:5 }}</p>
              </div>
            </div>
          </div>

          <!-- Pagination Controls -->
          <div class="pagination-controls" *ngIf="totalPages > 1">
            <button class="btn-page" (click)="prevPage()" [disabled]="currentPage === 1">Anterior</button>
            <span class="page-info">P√°gina {{ currentPage }} de {{ totalPages }}</span>
            <button class="btn-page" (click)="nextPage()" [disabled]="currentPage === totalPages">Siguiente</button>
          </div>
        </div>
      </div>

    </div>
  </main>

  <!-- Modal Invitaci√≥n -->
  <div class="modal-invitacion-overlay" *ngIf="showModalInvitacion">
    <div class="modal-invitacion-content animate-pop">
      <div class="modal-header">
        <h3>Agregar Compa√±ero</h3>
        <button class="close-btn" (click)="cerrarModal()">√ó</button>
      </div>
      <div class="modal-body">
        <p>Invita a un amigo para compartir este pack. Debe estar registrado en la App.</p>

        <div class="form-group">
          <label>Email del Jugador</label>
          <input [(ngModel)]="emailInvitado" type="email" placeholder="ejemplo@correo.com" class="form-input" />
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" (click)="cerrarModal()">Cancelar</button>
          <button class="btn-confirm" (click)="enviarInvitacion()">Confirmar</button>
        </div>
      </div>
    </div>
  </div>

</div>