<div class="admin-layout">
    <app-sidebar [userId]="userId" [jugadorNombre]="jugadorNombre" [jugadorFoto]="jugadorFoto" activePage="habilidades">
    </app-sidebar>

    <main class="main-content">

        <div class="dashboard-grid">
            <!-- Header section -->
            <div class="page-intro">
                <h1>Tu Rendimiento üéæ</h1>
                <p>Analiza tu evoluci√≥n t√©cnica y repasa tus mejores jugadas.</p>
            </div>

            <!-- Main Navigation Tabs -->
            <div class="main-tabs">
                <button [class.active]="selectedMainTab === 'habilidades'" (click)="selectedMainTab = 'habilidades'">
                    üìä Habilidades & Evoluci√≥n
                </button>
                <button [class.active]="selectedMainTab === 'videos'" (click)="selectedMainTab = 'videos'">
                    üé¨ Historial de Videos
                </button>
            </div>

            <!-- Skills & Stats Content -->
            <ng-container *ngIf="selectedMainTab === 'habilidades'">
                <div class="trainers-tabs" *ngIf="trainers.length > 1">
                    <button *ngFor="let t of trainers" class="tab-btn" [class.active]="selectedTrainerId === t.id"
                        (click)="selectTrainer(t.id)">
                        {{t.nombre}}
                    </button>
                </div>

                <div class="charts-row" *ngIf="!isLoading && hasData">
                    <div class="card chart-card">
                        <div class="card-title">Distribuci√≥n T√©cnica</div>
                        <div class="chart-container">
                            <canvas id="radarChart"></canvas>
                        </div>
                    </div>

                    <div class="card chart-card">
                        <div class="card-title">Evoluci√≥n de Promedio</div>
                        <div class="chart-container">
                            <canvas id="lineChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analysis Table -->
                <div class="card analysis-card" *ngIf="!isLoading && hasData">
                    <div class="card-title">Detalle por Golpe</div>
                    <div class="analysis-table-container">
                        <table class="analysis-table">
                            <thead>
                                <tr>
                                    <th>Golpe</th>
                                    <th>Promedio</th>
                                    <th>Detalle</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr *ngFor="let label of storedRadarLabels; let i = index">
                                    <td class="hit-name">{{ label }}</td>
                                    <td>
                                        <span class="score-badge" [class.high]="storedRadarData[i] >= 8"
                                            [class.mid]="storedRadarData[i] >= 5" [class.low]="storedRadarData[i] < 5">
                                            {{ storedRadarData[i] | number:'1.1-1' }}
                                        </span>
                                    </td>
                                    <td>
                                        <button class="info-btn" (click)="verDetalleGolpe(label)">
                                            ‚ÑπÔ∏è
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Empty Stats -->
                <div class="card empty-card" *ngIf="!isLoading && !hasData">
                    <div class="icon">üìà</div>
                    <h3>A√∫n no tienes evaluaciones</h3>
                    <p>Tus gr√°ficos aparecer√°n cuando tu entrenador realice tu primera evaluaci√≥n t√©cnica.</p>
                </div>
            </ng-container>

            <!-- Videos Section -->
            <div class="videos-section" *ngIf="!isLoading && selectedMainTab === 'videos'">
                <div class="section-title-row">
                    <div class="section-title">
                        <h2>üé¨ Biblioteca de Videos</h2>
                        <p>Explora tus sesiones y grabaciones personales organizadas por golpe.</p>
                    </div>
                    <div class="header-actions">
                        <button class="compare-mode-btn" [class.active]="isComparisonMode"
                            (click)="toggleComparisonMode()">
                            {{ isComparisonMode ? 'Cancelar Comparaci√≥n' : '‚öñÔ∏è Comparar Videos' }}
                        </button>
                        <button class="upload-btn-nike" (click)="subirVideoPersonal()">
                            SUBIR VIDEO
                        </button>
                    </div>
                </div>

                <!-- Origin and Category Selectors -->
                <div class="filters-container fade-in">
                    <div class="origin-selector">
                        <span class="label">Contenido de:</span>
                        <div class="pills">
                            <button [class.active]="activeOrigin === 'todos'" (click)="setOrigin('todos')">Todo</button>
                            <button [class.active]="activeOrigin === 'coach'"
                                (click)="setOrigin('coach')">Coach</button>
                            <button [class.active]="activeOrigin === 'personal'"
                                (click)="setOrigin('personal')">M√≠o</button>
                        </div>
                    </div>

                    <div class="category-pills">
                        <button *ngFor="let cat of availableCategories" class="pill"
                            [class.active]="activeCategory === cat" (click)="setCategory(cat)">
                            {{ cat }}
                            <span class="count" *ngIf="cat !== 'Todos'">{{ groupedVideos[cat]?.length }}</span>
                        </button>
                    </div>
                </div>

                <!-- Comparison Selection Bar -->
                <div class="comparison-bar shadow-lg" *ngIf="isComparisonMode && selectedVideos.length > 0">
                    <div class="selected-vids">
                        <div class="selected-item" *ngFor="let sv of selectedVideos">
                            <span class="dot"></span> {{ sv.titulo }}
                        </div>
                        <div class="placeholder" *ngIf="selectedVideos.length < 2">Selecciona otro video...</div>
                    </div>
                    <button class="launch-compare-btn" [disabled]="selectedVideos.length < 2"
                        (click)="openComparison()">
                        VER EN PARALELO
                    </button>
                </div>

                <div class="videos-grid" *ngIf="filteredVideos.length > 0; else noVideos">
                    <div class="video-card" *ngFor="let vid of filteredVideos"
                        [class.selected-for-compare]="isVideoSelected(vid)" [class.selectable]="isComparisonMode"
                        (click)="isComparisonMode ? selectVideoToCompare(vid) : null">

                        <div class="selection-overlay" *ngIf="isComparisonMode">
                            <div class="check-circle">{{ isVideoSelected(vid) ? '‚úì' : '' }}</div>
                        </div>

                        <div class="video-container">
                            <video [src]="vid.video_url" [controls]="!isComparisonMode" preload="metadata"
                                playsinline></video>
                        </div>
                        <div class="video-info">
                            <div class="vid-header">
                                <span class="badge">{{ vid.categoria }}</span>
                                <h4>{{ vid.titulo || 'Entrenamiento' }}</h4>
                            </div>
                            <span class="date">{{ vid.fecha | date:'dd/MM/yyyy' }}</span>
                            <p class="comment" *ngIf="vid.comentario">{{ vid.comentario }}</p>

                            <div class="ai-video-actions">
                                <button class="ai-btn-analyze" *ngIf="!aiResults[vid.id]"
                                    (click)="analizarVideo(vid); $event.stopPropagation()"
                                    [disabled]="isAnalyzing[vid.id]">
                                    {{ isAnalyzing[vid.id] ? 'ANALIZANDO...' : 'ANALIZAR CON IA' }}
                                </button>
                                <button class="ai-btn-report" *ngIf="aiResults[vid.id]"
                                    (click)="verReporte(vid); $event.stopPropagation()">
                                    VER REPORTE AI
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <ng-template #noVideos>
                    <div class="card empty-card mini">
                        <p>No tienes videos en esta secci√≥n todav√≠a.</p>
                    </div>
                </ng-template>
            </div>

            <!-- Video Comparison Overlay -->
            <div class="comparison-overlay" *ngIf="showComparison" [class.show]="showComparison">
                <div class="comparison-container fade-in">
                    <header class="comp-header">
                        <h3>‚öñÔ∏è Comparativa T√©cnica</h3>
                        <div class="header-actions">
                            <button class="play-both-btn" (click)="togglePlayBoth()">‚ñ∂Ô∏è Reproducir Ambos</button>
                            <button class="close-comp-btn" (click)="closeComparison()">Cerrar</button>
                        </div>
                    </header>
                    <div class="comp-vids-grid">
                        <div class="comp-vid-item" *ngFor="let vid of selectedVideos">
                            <div class="comp-vid-wrapper shadow-lg">
                                <video [src]="vid.video_url" controls loop playsinline></video>
                            </div>
                            <div class="comp-vid-info">
                                <span class="badge">{{ vid.categoria }}</span>
                                <h4>{{ vid.titulo }}</h4>
                                <p>{{ vid.fecha | date:'dd/MM/yyyy' }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div class="loading-overlay" *ngIf="isLoading">
                <div class="spinner"></div>
                <p>Analizando rendimiento...</p>
            </div>
        </div>
    </main>

    <!-- Gemini Analysis Results Modal (Web Overlay) -->
    <div class="ai-results-overlay" *ngIf="aiActiveResult" [class.show]="aiActiveResult">
        <div class="ai-results-card fade-in">
            <div class="results-header">
                <div class="header-main">
                    <h3>GEMINI IA: {{ aiActiveResult.title }}</h3>
                </div>
                <button class="close-btn" (click)="aiActiveResult = null">√ó</button>
            </div>

            <div class="results-body">
                <div class="ai-badge-header">POWERED BY GOOGLE AI STUDIO</div>

                <div class="score-section">
                    <div class="score-circle">
                        <span class="score-val">{{ aiActiveResult.score }}</span>
                        <span class="score-pct">%</span>
                    </div>
                    <p class="score-label">MATCH T√âCNICO</p>
                </div>

                <div class="feedback-text">
                    <p>{{ aiActiveResult.feedback }}</p>
                </div>

                <div class="metrics-grid">
                    <div class="metric-progress" *ngFor="let m of aiActiveResult.metrics">
                        <div class="metric-info">
                            <span>{{ m.label }}</span>
                            <span>{{ m.value }}/10</span>
                        </div>
                        <div class="progress-bg">
                            <div class="progress-fill" [style.width]="(m.value * 10) + '%'"></div>
                        </div>
                    </div>
                </div>

                <div class="tips-section">
                    <h4>TIPS DE MEJORA</h4>
                    <ul>
                        <li *ngFor="let tip of aiActiveResult.tips">{{ tip }}</li>
                    </ul>
                </div>

                <button class="understand-btn" (click)="aiActiveResult = null">
                    ENTENDIDO
                </button>
            </div>
        </div>
    </div>
</div>